{% extends "base.html" %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">WTB Opslag</div>
        <div class="text-2xl font-bold" id="wtb-count">{{ wtb_count }}</div>
        <div class="text-xs text-gray-400 mt-1" id="wtb-status">
            {% if scrape_status.wtb.running %}
                <span class="loader"></span> {{ scrape_status.wtb.progress }}
            {% elif scrape_status.wtb.last_run %}
                Sidst: {{ scrape_status.wtb.progress }}
            {% else %}
                Ikke hentet endnu
            {% endif %}
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Dine Produkter</div>
        <div class="text-2xl font-bold" id="products-count">{{ my_products_count }}</div>
        <div class="text-xs text-gray-400 mt-1" id="store-status">
            {% if scrape_status.store.running %}
                <span class="loader"></span> {{ scrape_status.store.progress }}
            {% elif scrape_status.store.last_run %}
                Sidst: {{ scrape_status.store.progress }}
            {% else %}
                Ikke indlæst endnu
            {% endif %}
        </div>
    </div>

    <div class="bg-red-50 rounded-lg shadow p-4">
        <div class="text-sm text-red-600">Mangler (Muligheder)</div>
        <div class="text-2xl font-bold text-red-700">{{ results.summary.missing_count }}</div>
        <div class="text-xs text-red-400 mt-1">Efterspurgt men ikke på lager</div>
    </div>

    <div class="bg-green-50 rounded-lg shadow p-4">
        <div class="text-sm text-green-600">På Lager & Efterspurgt</div>
        <div class="text-2xl font-bold text-green-700">{{ results.summary.in_stock_count }}</div>
        <div class="text-xs text-green-400 mt-1">Du har hvad andre søger</div>
    </div>
</div>

<!-- Schedule Settings -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <!-- WTB Schedule -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold">WTB Auto-hent</h2>
            <span class="{% if schedule.enabled %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %} px-2 py-1 rounded text-xs font-medium">
                {% if schedule.enabled %}TIL{% else %}FRA{% endif %}
            </span>
        </div>
        <p class="text-sm text-gray-500 mb-3">Henter automatisk WTB efterspørgsel fra butikker</p>
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">
                {% if schedule.enabled and schedule.times %}
                    Kl. {{ schedule.times | join(' og ') }}
                {% else %}
                    Ikke planlagt
                {% endif %}
            </span>
            <button onclick="toggleSchedule('wtb')" class="text-sm text-blue-600 hover:underline">
                {% if schedule.enabled %}Deaktivér{% else %}Aktivér{% endif %}
            </button>
        </div>
    </div>

    <!-- Nordic Sneakers Schedule -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold">Nordic Sneakers Auto-hent</h2>
            <span class="{% if store_schedule.enabled %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %} px-2 py-1 rounded text-xs font-medium">
                {% if store_schedule.enabled %}TIL{% else %}FRA{% endif %}
            </span>
        </div>
        <p class="text-sm text-gray-500 mb-3">Henter automatisk dine produkter fra Nordic Sneakers</p>
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">
                {% if store_schedule.enabled and store_schedule.times %}
                    Kl. {{ store_schedule.times | join(' og ') }}
                {% else %}
                    Ikke planlagt
                {% endif %}
            </span>
            <button onclick="toggleSchedule('store')" class="text-sm text-blue-600 hover:underline">
                {% if store_schedule.enabled %}Deaktivér{% else %}Aktivér{% endif %}
            </button>
        </div>
    </div>
</div>

<!-- WTB Store Management -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">WTB Butikker at Overvåge</h2>
    </div>

    <div class="flex flex-wrap gap-2 mb-4" id="stores-list">
        {% for store in stores %}
        <div class="flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1 text-sm {% if not store.enabled %}opacity-50{% endif %}">
            <span>{{ store.name }}</span>
            <button onclick="toggleStore({{ loop.index0 }})" class="text-gray-500 hover:text-blue-600" title="Toggle">
                {% if store.enabled %}
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>
                {% else %}
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"/><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"/></svg>
                {% endif %}
            </button>
            <button onclick="removeStore({{ loop.index0 }})" class="text-gray-500 hover:text-red-600" title="Remove">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
            </button>
        </div>
        {% endfor %}
        <button onclick="showAddStore()" class="flex items-center gap-1 bg-blue-100 text-blue-700 rounded-full px-3 py-1 text-sm hover:bg-blue-200">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
            Tilføj Butik
        </button>
    </div>

    <!-- Add Store Form (hidden by default) -->
    <div id="add-store-form" class="hidden border-t pt-4 mt-4">
        <div class="flex gap-2">
            <input type="text" id="new-store-name" placeholder="Butiksnavn (f.eks. Sneaker Shop)"
                   class="border rounded px-3 py-2 text-sm flex-1">
            <input type="text" id="new-store-url" placeholder="https://www.wtbmarketlist.eu/store/butiksnavn"
                   class="border rounded px-3 py-2 text-sm flex-[2]">
            <button onclick="addStore()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Tilføj</button>
            <button onclick="hideAddStore()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm hover:bg-gray-300">Annuller</button>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap gap-3 items-center">
        <button id="scrape-wtb-btn" onclick="startScrape('wtb')"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
            Hent WTB
        </button>

        <button id="scrape-store-btn" onclick="startScrape('store')"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
            Hent Butik
        </button>

        <div class="border-l pl-3 ml-3">
            <label class="text-sm text-gray-600 mr-2">Importér CSV:</label>
            <input type="file" id="csv-file" accept=".csv" onchange="uploadCSV()"
                   class="text-sm text-gray-500 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
        </div>

        <div class="ml-auto flex gap-2">
            <a href="/api/export/missing" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm">
                Eksportér Manglende
            </a>
            <a href="/api/export/all" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm">
                Eksportér Alle
            </a>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex flex-wrap gap-3 items-center">
        <div class="flex gap-1">
            <button id="filter-all" onclick="filterResults('all')"
                    class="filter-btn bg-blue-600 text-white px-3 py-1 rounded text-sm">Alle</button>
            <button id="filter-missing" onclick="filterResults('missing')"
                    class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm">Mangler</button>
            <button id="filter-in_stock" onclick="filterResults('in_stock')"
                    class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm">På Lager</button>
            <button id="filter-no_demand" onclick="filterResults('no_demand')"
                    class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm">Ingen Efterspørgsel</button>
        </div>

        <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500">Vis:</label>
            <select id="page-size" onchange="changePageSize()" class="border rounded px-2 py-1 text-sm">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="all">Alle</option>
            </select>
        </div>

        <div class="ml-auto">
            <input type="text" id="search-input" onkeyup="searchResults()" placeholder="Søg efter navn eller SKU..."
                   class="border rounded-lg px-3 py-1 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-16">Billede</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Navn</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mærke</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Efterspørgsel</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Butikker</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prisinterval</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for item in results.missing %}
            <tr class="result-row hover:bg-gray-50" data-status="missing">
                <td class="px-4 py-3">
                    <span class="badge-missing px-2 py-1 rounded-full text-xs font-medium">Mangler</span>
                </td>
                <td class="px-4 py-3">
                    {% if item.image_url %}
                    <img src="{{ item.image_url }}" alt="{{ item.wtb_name }}" class="w-12 h-12 object-cover rounded" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center" style="display:none;">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    {% else %}
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ item.wtb_name }}</td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ item.wtb_sku or '-' }}</td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ item.brand or '-' }}</td>
                <td class="px-4 py-3">
                    <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">
                        {{ item.demand_count }} butikker
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">
                    {% if item.stores_wanting %}
                        <div class="flex flex-wrap gap-1">
                            {% for store in item.stores_wanting %}
                                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs">{{ store }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">
                    {% if item.wtb_price_min %}
                        {{ item.wtb_price_min }}{% if item.wtb_price_max %} - {{ item.wtb_price_max }}{% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}

            {% for item in results.in_stock %}
            <tr class="result-row hover:bg-gray-50" data-status="in_stock">
                <td class="px-4 py-3">
                    <span class="badge-in-stock px-2 py-1 rounded-full text-xs font-medium">På Lager</span>
                </td>
                <td class="px-4 py-3">
                    {% if item.image_url %}
                    <img src="{{ item.image_url }}" alt="{{ item.my_product_name }}" class="w-12 h-12 object-cover rounded" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center" style="display:none;">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    {% else %}
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">
                    {{ item.my_product_name }}
                    {% if item.my_product_url %}
                    <a href="{{ item.my_product_url }}" target="_blank" class="text-blue-600 hover:underline ml-1 text-xs">vis</a>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ item.my_product_sku or '-' }}</td>
                <td class="px-4 py-3 text-sm text-gray-500">-</td>
                <td class="px-4 py-3">
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                        {{ item.demand_count }} butikker
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">
                    {% if item.stores_wanting %}
                        <div class="flex flex-wrap gap-1">
                            {% for store in item.stores_wanting %}
                                <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">{{ store }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">
                    {% if item.my_product_price %}{{ item.my_product_price }}{% else %}-{% endif %}
                </td>
            </tr>
            {% endfor %}

            {% for item in results.no_demand %}
            <tr class="result-row hover:bg-gray-50" data-status="no_demand">
                <td class="px-4 py-3">
                    <span class="badge-no-demand px-2 py-1 rounded-full text-xs font-medium">Ingen Efterspørgsel</span>
                </td>
                <td class="px-4 py-3">
                    {% if item.image_url %}
                    <img src="{{ item.image_url }}" alt="{{ item.my_product_name }}" class="w-12 h-12 object-cover rounded" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center" style="display:none;">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    {% else %}
                    <div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">
                    {{ item.my_product_name }}
                    {% if item.my_product_url %}
                    <a href="{{ item.my_product_url }}" target="_blank" class="text-blue-600 hover:underline ml-1 text-xs">vis</a>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ item.my_product_sku or '-' }}</td>
                <td class="px-4 py-3 text-sm text-gray-500">-</td>
                <td class="px-4 py-3 text-sm text-gray-400">-</td>
                <td class="px-4 py-3 text-sm text-gray-400">-</td>
                <td class="px-4 py-3 text-sm text-gray-500">
                    {% if item.my_product_price %}{{ item.my_product_price }}{% else %}-{% endif %}
                </td>
            </tr>
            {% endfor %}

            {% if not results.missing and not results.in_stock and not results.no_demand %}
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                    <p class="text-lg mb-2">Ingen data endnu</p>
                    <p class="text-sm">Klik på "Hent WTB" for at hente markedsefterspørgsel, og importér dine produkter via CSV eller hent fra din butik.</p>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="bg-gray-50 px-4 py-3 border-t flex items-center justify-between">
        <div class="text-sm text-gray-500">
            Viser <span id="showing-start">1</span>-<span id="showing-end">50</span> af <span id="total-filtered">0</span> resultater
        </div>
        <div class="flex gap-1" id="pagination-controls">
            <button onclick="goToPage(1)" id="page-first" class="px-3 py-1 rounded text-sm bg-gray-200 hover:bg-gray-300 disabled:opacity-50" disabled>«</button>
            <button onclick="prevPage()" id="page-prev" class="px-3 py-1 rounded text-sm bg-gray-200 hover:bg-gray-300 disabled:opacity-50" disabled>‹</button>
            <span class="px-3 py-1 text-sm">Side <span id="current-page">1</span> af <span id="total-pages">1</span></span>
            <button onclick="nextPage()" id="page-next" class="px-3 py-1 rounded text-sm bg-gray-200 hover:bg-gray-300 disabled:opacity-50">›</button>
            <button onclick="goToPage(totalPages)" id="page-last" class="px-3 py-1 rounded text-sm bg-gray-200 hover:bg-gray-300 disabled:opacity-50">»</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Pagination state
let currentPage = 1;
let pageSize = 50;
let totalPages = 1;
let filteredRows = [];

// Initialize pagination on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePagination();
});

function updatePagination() {
    const allRows = document.querySelectorAll('.result-row');
    filteredRows = Array.from(allRows).filter(row => row.style.display !== 'none');

    const totalFiltered = filteredRows.length;

    if (pageSize === 'all' || pageSize >= totalFiltered) {
        totalPages = 1;
        currentPage = 1;
    } else {
        totalPages = Math.ceil(totalFiltered / pageSize);
        if (currentPage > totalPages) currentPage = totalPages || 1;
    }

    // Hide all rows first
    allRows.forEach(row => row.classList.add('pagination-hidden'));

    // Show only current page rows
    const startIdx = (currentPage - 1) * (pageSize === 'all' ? totalFiltered : pageSize);
    const endIdx = pageSize === 'all' ? totalFiltered : Math.min(startIdx + pageSize, totalFiltered);

    for (let i = 0; i < filteredRows.length; i++) {
        if (i >= startIdx && i < endIdx) {
            filteredRows[i].classList.remove('pagination-hidden');
        }
    }

    // Update UI
    document.getElementById('showing-start').textContent = totalFiltered === 0 ? 0 : startIdx + 1;
    document.getElementById('showing-end').textContent = endIdx;
    document.getElementById('total-filtered').textContent = totalFiltered;
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent = totalPages;

    // Update button states
    document.getElementById('page-first').disabled = currentPage <= 1;
    document.getElementById('page-prev').disabled = currentPage <= 1;
    document.getElementById('page-next').disabled = currentPage >= totalPages;
    document.getElementById('page-last').disabled = currentPage >= totalPages;
}

function goToPage(page) {
    currentPage = Math.max(1, Math.min(page, totalPages));
    updatePagination();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        updatePagination();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
    }
}

function changePageSize() {
    const select = document.getElementById('page-size');
    pageSize = select.value === 'all' ? 'all' : parseInt(select.value);
    currentPage = 1;
    updatePagination();
}

// Override filter and search to work with pagination
const originalFilterResults = window.filterResults;
window.filterResults = function(status) {
    const rows = document.querySelectorAll('.result-row');
    rows.forEach(row => {
        row.classList.remove('pagination-hidden');
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // Update active filter button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    document.getElementById(`filter-${status}`).classList.remove('bg-gray-200', 'text-gray-700');
    document.getElementById(`filter-${status}`).classList.add('bg-blue-600', 'text-white');

    currentPage = 1;
    updatePagination();
};

window.searchResults = function() {
    const query = document.getElementById('search-input').value.toLowerCase();
    const rows = document.querySelectorAll('.result-row');
    rows.forEach(row => {
        row.classList.remove('pagination-hidden');
        const text = row.textContent.toLowerCase();
        if (text.includes(query)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    currentPage = 1;
    updatePagination();
};

// Store Management
function showAddStore() {
    document.getElementById('add-store-form').classList.remove('hidden');
}

function hideAddStore() {
    document.getElementById('add-store-form').classList.add('hidden');
    document.getElementById('new-store-name').value = '';
    document.getElementById('new-store-url').value = '';
}

async function addStore() {
    const name = document.getElementById('new-store-name').value.trim();
    const url = document.getElementById('new-store-url').value.trim();

    if (!name || !url) {
        alert('Indtast venligst både navn og URL');
        return;
    }

    try {
        const response = await fetch('/api/stores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, url })
        });
        const data = await response.json();

        if (response.ok) {
            location.reload();
        } else {
            alert(data.error || 'Kunne ikke tilføje butik');
        }
    } catch (e) {
        alert('Fejl: ' + e.message);
    }
}

async function removeStore(index) {
    if (!confirm('Fjern denne butik?')) return;

    try {
        await fetch(`/api/stores/${index}`, { method: 'DELETE' });
        location.reload();
    } catch (e) {
        alert('Fejl: ' + e.message);
    }
}

async function toggleStore(index) {
    try {
        await fetch(`/api/stores/${index}/toggle`, { method: 'PUT' });
        location.reload();
    } catch (e) {
        alert('Fejl: ' + e.message);
    }
}

async function toggleSchedule(type) {
    try {
        const response = await fetch('/api/stores');
        const config = await response.json();

        if (type === 'store') {
            // Toggle Nordic Sneakers schedule
            const storeSchedule = config.store_schedule || { enabled: false, times: ['07:00', '19:00'] };
            const newEnabled = !storeSchedule.enabled;

            await fetch('/api/store-schedule', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    enabled: newEnabled,
                    times: storeSchedule.times || ['07:00', '19:00']
                })
            });
        } else {
            // Toggle WTB schedule
            const newEnabled = !config.schedule.enabled;

            await fetch('/api/schedule', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    enabled: newEnabled,
                    times: config.schedule.times || ['08:00', '20:00']
                })
            });
        }
        location.reload();
    } catch (e) {
        alert('Fejl: ' + e.message);
    }
}

// CSV Upload
async function uploadCSV() {
    const fileInput = document.getElementById('csv-file');
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/import/csv', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (response.ok) {
            alert(`${data.count} produkter importeret!`);
            location.reload();
        } else {
            alert(`Fejl: ${data.error}`);
        }
    } catch (e) {
        alert('Upload fejlede: ' + e.message);
    }

    fileInput.value = '';
}
</script>
{% endblock %}
